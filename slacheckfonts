#!/bin/bash

# v0.2
# slacheckfonts : tests whether all used fonts are either embeded or subset=vectorized

# TODO : detect fonts that are used in unused styles definitions and dont warn about them or with special message.

if [ "$1" = "-?" ] || [ "$1" = "-h" ]
then
	echo "Usage : slacheckfont [-h] [-v] [-vecto] scribusfile"
	echo "Checks whether all used fonts are either embeded or subset in scribusfile.sla"
	echo "Options :"
	echo -h displays this help
	echo -v displays details
	echo -vecto : check that fonts are all vectorised
	exit
fi

if [ "$1" = "-v" ]
then
	verbose=oui
	shift
fi

vecto=""
if [ "$1" = "-vecto" ]
then
	vecto="-vecto"
	shift
fi

if [ "$1" = "" ]
then
	echo Error : scribus file argument missing
	exit
fi

# fonts possible uses are :
#   <ITEXT FONT="Arimo Regular" CH="â€¯"/>
#	<CHARSTYLE CNAME="Default Character Style" DefaultStyle="1" FONT="Liberation Sans Regular" FONTSIZE="8.8" FCOLOR="Black"/>
#	<STYLE NAME="NoteSignature" PARENT="Signature" PSHORTCUT="Ctrl+Alt+(" FONT="Liberation Sans Regular"/>
#	<tab FONT="Wingdings Regular" FONTSIZE="15"/>

# s/regexp/replacement/ ! The replacement may contain the special character & to refer to that portion of the pattern space which matched

used=`grep " FONT=\"[^\"]*\"" $1.sla | sed -e 's/^.* FONT=\(\"[^\"]*\"\).*$/\1/'`

# Embeded fonts
# 	<Fonts Name="CC Icons Regular"/>
# Subseted fonts (vectorized)
# 	<Subset Name="Arimo Regular"/>

if [ "$vecto" != "-vecto" ]
then
	known=`sed -n '/\(<Fonts \|Subset \)/p' $1.sla | sed 's/.*Name=\(\"[^\"]*\"\).*$/\1/'`
	errormessage="font is neither vectorized nor embeded"
else
	known=`sed -n '/\(<Subset \)/p' $1.sla | sed 's/.*Name=\(\"[^\"]*\"\).*$/\1/'`
	errormessage="font is not vectorized"	
fi

# known=`sed -n '/\(<Fonts \|Subset \)/p' $1.sla | sed 's/.*Name=\(\"[^\"]*\"\).*$/\1/'`

if [ "$verbose" = oui ]
then
	echo Embeded or subset fonts are : $known
fi


IFS=$'\n'
for usedfont in $used
do 
	recognised=""
	for knownfont in $known
	do
		if [ "$usedfont" = "$knownfont" ]
		then recognised=oui;
		fi
	done
	if [ "$recognised" = "" ]
	then echo "Error in $1.sla with '$usedfont' : $errormessage"
	fi
done

exit
